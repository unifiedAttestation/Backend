generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  app_dev
  oem
  admin
}

enum FederationStatus {
  active
  disabled
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  role         UserRole
  disabledAt   DateTime?
  displayName  String?
  createdAt    DateTime @default(now())
  apps         App[]
  oemOrg       OemOrg? @relation("OemOrgMembers", fields: [oemOrgId], references: [id])
  oemOrgId     String?
  ownedOemOrg  OemOrg? @relation("OemOrgOwner")
}

model App {
  id                 String   @id @default(cuid())
  projectId          String   @unique
  name               String
  packageName        String
  signerDigestSha256 String
  apiSecretHash      String
  apiSecretPrefix    String
  createdAt          DateTime @default(now())
  ownerUserId        String
  ownerUser          User     @relation(fields: [ownerUserId], references: [id])
  reports            DeviceReport[]
}

model DeviceReport {
  id              String   @id @default(cuid())
  appId           String
  scopedDeviceId  String
  issuerBackendId String
  deviceFamilyId  String?
  buildPolicyId   String?
  buildPolicyName String?
  lastSeen        DateTime
  lastVerdict     Json
  lastState       Json
  app             App      @relation(fields: [appId], references: [id])
  deviceFamily    DeviceFamily? @relation(fields: [deviceFamilyId], references: [id])
  buildPolicy     BuildPolicy? @relation(fields: [buildPolicyId], references: [id])

  @@unique([appId, scopedDeviceId], name: "appId_scopedDeviceId")
}

model OemOrg {
  id           String   @id @default(cuid())
  name         String
  ownerUserId  String   @unique
  ownerUser    User     @relation("OemOrgOwner", fields: [ownerUserId], references: [id])
  manufacturer String?
  brand        String?
  createdAt    DateTime @default(now())
  users        User[]   @relation("OemOrgMembers")
  deviceFamilies DeviceFamily[]
}

model DeviceFamily {
  id                  String   @id @default(cuid())
  oemOrgId            String
  name                String
  codename            String?
  model               String?
  manufacturer        String?
  brand               String?
  createdAt           DateTime @default(now())
  oemOrg              OemOrg   @relation(fields: [oemOrgId], references: [id])
  trustAnchors        DeviceFamilyTrustAnchor[]
  buildPolicies       BuildPolicy[]
  reports             DeviceReport[]
}

model TrustAnchor {
  id             String   @id @default(cuid())
  name           String
  pem            String
  createdAt      DateTime @default(now())
  deviceFamilies DeviceFamilyTrustAnchor[]
}

model DeviceFamilyTrustAnchor {
  id             String   @id @default(cuid())
  deviceFamilyId String
  trustAnchorId  String
  createdAt      DateTime @default(now())
  deviceFamily   DeviceFamily @relation(fields: [deviceFamilyId], references: [id])
  trustAnchor    TrustAnchor @relation(fields: [trustAnchorId], references: [id])

  @@unique([deviceFamilyId, trustAnchorId])
}

model BuildPolicy {
  id                      String   @id @default(cuid())
  deviceFamilyId          String
  name                    String
  verifiedBootKeyHex      String
  verifiedBootHashHex     String?
  osVersionRaw            Int?
  minOsPatchLevelRaw      Int?
  minVendorPatchLevelRaw  Int?
  minBootPatchLevelRaw    Int?
  expectedDeviceLocked    Boolean?
  expectedVerifiedBootState String?
  enabled                 Boolean @default(true)
  createdAt               DateTime @default(now())
  deviceFamily            DeviceFamily @relation(fields: [deviceFamilyId], references: [id])
  reports                 DeviceReport[]
}

model FederationBackend {
  id         String   @id @default(cuid())
  backendId  String   @unique
  name       String
  url        String?
  publicKeys Json
  status     FederationStatus
  createdAt  DateTime @default(now())
}
